<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Temp√©rature & Humidit√©</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f0f0f0;
    color: #333;
    text-align: center;
    margin: 0;
    padding: 0;
  }

  h1 {
    margin-top: 20px;
    font-size: 2em;
    color: #222;
  }

  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    padding: 15px 20px;
    margin: 15px auto;
    max-width: 300px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.15);
  }

  .value {
    font-size: 1.8em;
    margin: 8px 0;
    font-weight: bold;
    color: #0077cc;
  }

  .small {
    font-size: 0.9em;
    color: #555;
  }

  #chart-container {
    width: 90%;
    max-width: 900px;
    margin: 20px auto;
  }

  canvas {
    width: 100% !important;
    height: 300px !important;
  }

  @media (max-width: 600px) {
    h1 { font-size: 1.5em; }
    .value { font-size: 1.5em; }
    canvas { height: 250px !important; }
  }
</style>
</head>
<body>

<h1>üå° Temp√©rature & Humidit√©</h1>

<div class="card" id="tempCard">
  <p>Temp√©rature : <span id="temp" class="value">--</span> ¬∞C</p>
  <p class="small">Derni√®re mesure : <span id="time">--:--</span></p>
</div>

<div class="card" id="humCard">
  <p>Humidit√© : <span id="hum" class="value">--</span> %</p>
  <p class="small">Derni√®re mesure : <span id="time2">--:--</span></p>
</div>

<div id="chart-container">
  <canvas id="chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
const ctx = document.getElementById('chart').getContext('2d');

const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      { label: 'Temp√©rature (¬∞C)', data: [], borderColor: '#ff7f0e', fill: false, tension: 0.3 },
      { label: 'Humidit√© (%)', data: [], borderColor: '#1f77b4', fill: false, tension: 0.3 }
    ]
  },
  options: {
    plugins: {
      legend: { labels: { color: '#333' } },
      datalabels: { color: '#333', align: 'top', font: { weight: 'bold' } },
      tooltip: { enabled: true }
    },
    scales: {
      x: { ticks: { color: '#333', autoSkip: true, maxTicksLimit: 12 } },
      y: { beginAtZero: true, ticks: { color: '#333' } }
    },
    responsive: true,
    maintainAspectRatio: false
  },
  plugins: [ChartDataLabels]
});

const sheetURL = "https://script.google.com/macros/s/AKfycbxKoOoH_5MR4dBtjszaKRDPqk-KtBRbkNFkrJNwHlFSHO-RUMiVzusZUb5smqRIGgAz/exec";

let allData = [];
let graphData = [];

async function getData() {
  try {
    const res = await fetch(sheetURL);
    const json = await res.json();
    allData = json;

    const last = allData[allData.length - 1];
    document.getElementById('temp').textContent = last.temperature.toFixed(1);
    document.getElementById('hum').textContent = last.humidity.toFixed(1);
    document.getElementById('time').textContent = new Date(last.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('time2').textContent = document.getElementById('time').textContent;

    // Garder les points toutes les 10 min pour le graphique mais r√©duire automatiquement si trop nombreux
    graphData = allData.filter((_, index) => index % 10 === 0);
    const maxPoints = 20; // max points affich√©s sur l‚Äô√©cran
    const step = Math.max(1, Math.floor(graphData.length / maxPoints));
    const displayData = graphData.filter((_, i) => i % step === 0);

    chart.data.labels = displayData.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
    chart.data.datasets[0].data = displayData.map(d => d.temperature);
    chart.data.datasets[1].data = displayData.map(d => d.humidity);
    chart.update();

  } catch(e) {
    console.error("Erreur r√©cup√©ration donn√©es :", e);
  }
}

setInterval(getData, 60000); // toutes les 1 min
getData();

// Interactivit√© des cartes
document.getElementById('tempCard').addEventListener('click', () => {
  alert('Graphique d√©taill√© de la temp√©rature');
});
document.getElementById('humCard').addEventListener('click', () => {
  alert('Graphique d√©taill√© de l\'humidit√©');
});
</script>

</body>
</html>
